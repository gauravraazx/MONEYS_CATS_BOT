<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1" />
  <title>Create — CATS</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-bg-color,#0a0a0f);
      --fg: var(--tg-theme-text-color,#fff);
      --card: var(--tg-theme-secondary-bg-color,#1a1a24);
      --accent: var(--tg-theme-button-color,#8b5cf6);
      --accent-text: var(--tg-theme-button-text-color,#fff);
      --sep: var(--tg-theme-section-separator-color,#2a2a3a);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --nav-offset: 100px;
      --wrap-max: 480px;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;overflow-x:hidden;touch-action:pan-y;-webkit-user-select:none;user-select:none}
    body{
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,sans-serif;
      background:linear-gradient(180deg, var(--bg) 0%, #1a0a2e 100%);
      color:var(--fg);
      padding-bottom: var(--nav-offset);
    }
    .wrap{max-width:var(--wrap-max);margin:0 auto;padding:20px 16px}
    .header{
      text-align:center;margin-bottom:24px;padding:20px 0;
      background:linear-gradient(135deg, rgba(139,92,246,0.1) 0%, rgba(59,130,246,0.1) 100%);
      border-radius:20px;border:1px solid rgba(139,92,246,0.2);
    }
    .header h1{font-size:20px;font-weight:800;letter-spacing:2px;margin-bottom:8px;
      background:linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header p{font-size:13px;opacity:0.7}
    .back-btn{display:inline-flex;align-items:center;gap:8px;padding:12px 20px;border-radius:12px;border:0;background:rgba(139,92,246,0.2);color:var(--fg);font-weight:600;font-size:14px;cursor:pointer;margin-bottom:20px;transition:all .3s}
    .back-btn:active{transform:scale(0.95)}
    .tabs{display:flex;gap:12px;margin-bottom:24px}
    .tab-btn{flex:1;padding:14px;border-radius:14px;border:0;background:rgba(26,26,36,0.6);color:var(--fg);font-weight:700;font-size:14px;cursor:pointer;transition:all .3s;border:1px solid rgba(139,92,246,0.2)}
    .tab-btn.active{background:linear-gradient(135deg, rgba(139,92,246,0.3) 0%, rgba(59,130,246,0.3) 100%);border-color:rgba(139,92,246,0.5);box-shadow:0 4px 16px rgba(139,92,246,0.3)}
    .tab-btn:active{transform:scale(0.98)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .form-card{background:rgba(26,26,36,0.8);backdrop-filter:blur(10px);border-radius:16px;padding:24px;margin-bottom:20px;border:1px solid rgba(139,92,246,0.2)}
    .form-group{margin-bottom:20px}
    .form-label{display:block;font-size:14px;font-weight:600;margin-bottom:8px;color:rgba(255,255,255,0.9)}
    .form-input,.form-textarea{width:100%;padding:14px;border-radius:12px;border:1px solid rgba(139,92,246,0.3);background:rgba(0,0,0,0.3);color:var(--fg);outline:none;font-size:14px;font-family:inherit;transition:all .3s}
    .form-textarea{min-height:100px;resize:vertical}
    .form-input:focus,.form-textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(139,92,246,0.1)}
    .form-hint{font-size:12px;opacity:0.6;margin-top:6px}
    .info-box{background:rgba(59,130,246,0.1);border-radius:12px;padding:16px;margin-bottom:20px;border:1px solid rgba(59,130,246,0.3)}
    .info-box strong{color:#3b82f6;display:block;margin-bottom:8px}
    .info-box p{font-size:13px;line-height:1.6;opacity:0.9}
    .calc-box{background:rgba(16,185,129,0.1);border-radius:12px;padding:16px;margin-top:12px;border:1px solid rgba(16,185,129,0.3);display:flex;justify-content:space-between;align-items:center}
    .calc-box.danger{background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.35)}
    .calc-box span{font-size:13px;opacity:0.9}
    .calc-box strong{color:var(--success);font-size:16px}
    .calc-box.danger strong{color:var(--danger)}
    .submit-btn{width:100%;padding:16px;border:0;border-radius:14px;background:linear-gradient(135deg, var(--accent) 0%, #6d28d9 100%);color:var(--accent-text);font-weight:700;font-size:16px;cursor:pointer;transition:all .3s;box-shadow:0 4px 20px rgba(139,92,246,0.4);position:relative;overflow:hidden}
    .submit-btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,0.2);border-radius:50%;transform:translate(-50%,-50%);transition:width .6s,height .6s}
    .submit-btn:active::before{width:300px;height:300px}
    .submit-btn:active{transform:translateY(2px);box-shadow:0 2px 10px rgba(139,92,246,0.3)}
    .submit-btn[disabled]{opacity:.5;cursor:not-allowed;background:linear-gradient(135deg, #555 0%, #333 100%)}
    .balance-card{background:rgba(26,26,36,0.8);backdrop-filter:blur(10px);border-radius:16px;padding:16px;margin-bottom:16px;border:1px solid rgba(139,92,246,0.25);display:flex;justify-content:space-between;align-items:center}
    .balance-title{font-weight:800;opacity:.9}
    .balance-value{font-weight:900;font-size:20px;color:var(--accent)}
    .ton-balance-box{
      background:rgba(245,158,11,0.1);
      border:1px solid rgba(245,158,11,0.3);
      border-radius:12px;
      padding:16px;
      margin-bottom:16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .ton-balance-left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .ton-balance-label{
      font-size:12px;
      opacity:0.7;
      font-weight:600;
    }
    .ton-balance-amount{
      font-size:24px;
      font-weight:900;
      color:var(--warning);
    }
    .deposit-btn{
      padding:10px 20px;
      border:0;
      border-radius:10px;
      background:linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
      color:#000;
      font-weight:800;
      font-size:14px;
      cursor:pointer;
      transition:all .3s;
      box-shadow:0 4px 16px rgba(245,158,11,0.3);
    }
    .deposit-btn:active{
      transform:scale(0.95);
    }
    .list-card{background:rgba(26,26,36,0.8);backdrop-filter:blur(10px);border-radius:16px;padding:20px;border:1px solid rgba(139,92,246,0.2)}
    .list-card>div:first-child{font-weight:800;margin-bottom:16px;font-size:16px}
    .promo-item{
      background:rgba(139,92,246,0.08);
      border-radius:14px;
      padding:16px;
      margin-bottom:12px;
      border:1px solid rgba(139,92,246,0.2);
      transition:all .3s;
    }
    .promo-item:last-child{margin-bottom:0}
    .promo-item.exhausted{
      background:rgba(239,68,68,0.08);
      border-color:rgba(239,68,68,0.3);
    }
    .promo-item.exhausted .promo-header{opacity:0.6}
    .promo-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .promo-code-wrapper{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .promo-code{
      font-weight:900;
      letter-spacing:1px;
      font-size:16px;
      color:var(--accent);
      font-family:'Courier New', monospace;
    }
    .promo-item.exhausted .promo-code{
      color:var(--danger);
    }
    .copy-btn{
      padding:6px 12px;
      border-radius:8px;
      border:0;
      background:rgba(139,92,246,0.3);
      color:var(--fg);
      font-size:12px;
      font-weight:700;
      cursor:pointer;
      transition:all .2s;
    }
    .copy-btn:active{
      transform:scale(0.9);
      background:rgba(139,92,246,0.5);
    }
    .promo-item.exhausted .copy-btn{
      background:rgba(239,68,68,0.3);
    }
    .promo-status{
      display:inline-block;
      padding:4px 10px;
      border-radius:6px;
      font-size:11px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .promo-status.active{
      background:rgba(16,185,129,0.2);
      color:var(--success);
    }
    .promo-status.exhausted{
      background:rgba(239,68,68,0.2);
      color:var(--danger);
    }
    .promo-stats{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      font-size:13px;
    }
    .promo-stat{
      background:rgba(0,0,0,0.3);
      padding:8px 12px;
      border-radius:8px;
    }
    .promo-stat-label{
      opacity:0.7;
      font-size:11px;
      margin-bottom:2px;
    }
    .promo-stat-value{
      font-weight:800;
      font-size:14px;
    }
    .promo-progress{
      margin-top:12px;
      height:6px;
      background:rgba(0,0,0,0.3);
      border-radius:3px;
      overflow:hidden;
    }
    .promo-progress-bar{
      height:100%;
      background:linear-gradient(90deg, var(--success) 0%, #34d399 100%);
      transition:width .3s;
    }
    .promo-item.exhausted .promo-progress-bar{
      background:linear-gradient(90deg, var(--danger) 0%, #f87171 100%);
    }
    .nav{position:fixed;z-index:1000;left:0;right:0;bottom:0;background:rgba(26,26,36,0.95);backdrop-filter:blur(20px);padding:12px 12px calc(12px + env(safe-area-inset-bottom,0px));border-top:1px solid rgba(139,92,246,0.2);box-shadow:0 -8px 32px rgba(0,0,0,0.5)}
    .nav-row{max-width:var(--wrap-max);margin:0 auto;display:flex;gap:10px;height:70px;align-items:center}
    .tab{flex:1;text-align:center;padding:12px;border-radius:14px;background:rgba(0,0,0,0.3);color:var(--fg);font-weight:600;font-size:13px;cursor:pointer;user-select:none;transition:all .3s;border:1px solid transparent}
    .tab.active{background:linear-gradient(135deg, rgba(139,92,246,0.3) 0%, rgba(59,130,246,0.3) 100%);border-color:rgba(139,92,246,0.5);box-shadow:0 4px 16px rgba(139,92,246,0.3)}
    .tab:active{transform:scale(0.95)}

    /* Deposit Modal */
    .modal{
      display:none;
      position:fixed;
      z-index:2000;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.85);
      backdrop-filter:blur(10px);
      align-items:center;
      justify-content:center;
    }
    .modal.show{display:flex}
    .modal-content{
      background:linear-gradient(135deg, rgba(26,26,36,0.98) 0%, rgba(10,10,15,0.98) 100%);
      border-radius:20px;
      padding:28px;
      max-width:90%;
      width:400px;
      border:2px solid rgba(139,92,246,0.3);
      box-shadow:0 20px 60px rgba(0,0,0,0.5);
      animation:modalSlideIn 0.3s ease-out;
    }
    @keyframes modalSlideIn{
      from{transform:translateY(-50px);opacity:0}
      to{transform:translateY(0);opacity:1}
    }
    .modal-header{
      text-align:center;
      margin-bottom:24px;
    }
    .modal-header h2{
      font-size:22px;
      font-weight:900;
      background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      margin-bottom:8px;
    }
    .modal-header p{
      font-size:13px;
      opacity:0.7;
    }
    .deposit-info{
      background:rgba(0,0,0,0.3);
      border-radius:14px;
      padding:16px;
      margin-bottom:16px;
    }
    .deposit-field{
      margin-bottom:16px;
    }
    .deposit-field:last-child{margin-bottom:0}
    .deposit-field-label{
      font-size:12px;
      font-weight:700;
      opacity:0.7;
      margin-bottom:8px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .deposit-field-value{
      background:rgba(139,92,246,0.1);
      border:1px solid rgba(139,92,246,0.3);
      border-radius:10px;
      padding:12px;
      font-family:'Courier New', monospace;
      font-size:13px;
      word-break:break-all;
      position:relative;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .deposit-field-text{
      flex:1;
      font-weight:600;
    }
    .mini-copy-btn{
      padding:6px 10px;
      border:0;
      border-radius:6px;
      background:rgba(139,92,246,0.3);
      color:var(--fg);
      font-size:11px;
      font-weight:700;
      cursor:pointer;
      transition:all .2s;
      flex-shrink:0;
    }
    .mini-copy-btn:active{
      transform:scale(0.9);
      background:rgba(139,92,246,0.5);
    }
    .modal-close-btn{
      width:100%;
      padding:14px;
      border:0;
      border-radius:12px;
      background:rgba(139,92,246,0.2);
      color:var(--fg);
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      transition:all .3s;
      margin-top:16px;
    }
    .modal-close-btn:active{
      transform:scale(0.98);
      background:rgba(139,92,246,0.3);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <button class="back-btn" id="backBtn">← Back to Earn</button>

    <div class="header">
      <h1>🎨 CREATE</h1>
      <p>Create Tasks & Promo Codes</p>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="task">📋 Create Task</button>
      <button class="tab-btn" data-tab="promo">🎟️ Create Promo</button>
    </div>

    <!-- CREATE TASK Tab -->
    <div class="tab-content active" id="taskTab">
      <div class="info-box">
        <strong>ℹ️ Task Creation Info</strong>
        <p>• 0.05 TON = 100 users max • 1 TON = 2000 users max</p>
      </div>

      <!-- TON Balance Box -->
      <div class="ton-balance-box">
        <div class="ton-balance-left">
          <div class="ton-balance-label">💎 TON Balance</div>
          <div class="ton-balance-amount" id="tonBalance">0.00</div>
        </div>
        <button class="deposit-btn" id="depositBtn">➕ Deposit</button>
      </div>

      <div class="form-card">
        <div class="form-group">
          <label class="form-label">Task Title</label>
          <input type="text" class="form-input" id="taskTitle" placeholder="e.g., Follow our Twitter">
          <div class="form-hint">Short and descriptive title</div>
        </div>

        <div class="form-group">
          <label class="form-label">Task Link</label>
          <input type="url" class="form-input" id="taskLink" placeholder="https://t.me/yourchannel">
          <div class="form-hint">URL where users complete the task</div>
        </div>

        <div class="form-group">
          <label class="form-label">Budget Amount (TON)</label>
          <input type="number" class="form-input" id="taskAmount" placeholder="0.05" min="0.05" step="0.01" value="0.05">
          <div class="form-hint">Minimum 0.05 TON required</div>
          <div class="calc-box" id="taskCalc">
            <span>Maximum Users:</span>
            <strong id="maxUsers">100</strong>
          </div>
        </div>
        <button class="submit-btn" id="createTaskBtn">🚀 Create Task</button>
      </div>
    </div>

    <!-- CREATE PROMO Tab -->
    <div class="tab-content" id="promoTab">
      <div class="balance-card">
        <div class="balance-title">CATS Balance</div>
        <div class="balance-value" id="catsBalance">0</div>
      </div>

      <div class="form-card">
        <div class="form-group">
          <label class="form-label">Total Budget (CATS)</label>
          <input type="number" class="form-input" id="promoBudget" placeholder="e.g., 1000" min="10">
          <div class="form-hint">Budget must be at least 10× Max Users</div>
        </div>

        <div class="form-group">
          <label class="form-label">Max Uses (users)</label>
          <input type="number" class="form-input" id="promoMaxUses" placeholder="e.g., 100" min="1">
          <div class="form-hint">How many users can redeem this code</div>
        </div>

        <div class="calc-box" id="minBox">
          <span>Minimum Required (Users × 10):</span>
          <strong id="minRequiredCats">0</strong>
        </div>
        <div class="calc-box" id="afterBox" style="margin-top:8px">
          <span>After Creation (Balance − Budget):</span>
          <strong id="afterBalanceCats">0</strong>
        </div>

        <button class="submit-btn" id="createPromoBtn" disabled>🎟️ Generate & Create Promo</button>
      </div>

      <div class="list-card" id="promoHistory">
        <div>🎟️ Your Promo Codes</div>
        <div id="promoListEmpty" style="font-size:13px;opacity:.7;text-align:center;padding:20px 0">No promo codes yet</div>
        <div id="promoList"></div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="nav">
    <div class="nav-row">
      <div class="tab" id="tabEarn">💰 Earn</div>
      <div class="tab" id="tabWatch">📺 Watch</div>
      <div class="tab" id="tabWithdraw">💳 Withdraw</div>
    </div>
  </div>

  <!-- Deposit Modal -->
  <div class="modal" id="depositModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>💎 Deposit TON</h2>
        <p>Send TON to the address below with memo</p>
      </div>
      <div class="deposit-info">
        <div class="deposit-field">
          <div class="deposit-field-label">📍 Wallet Address</div>
          <div class="deposit-field-value">
            <span class="deposit-field-text" id="depositAddress">Loading...</span>
            <button class="mini-copy-btn" id="copyAddress">Copy</button>
          </div>
        </div>
        <div class="deposit-field">
          <div class="deposit-field-label">📝 Memo (Required)</div>
          <div class="deposit-field-value">
            <span class="deposit-field-text" id="depositMemo">Loading...</span>
            <button class="mini-copy-btn" id="copyMemo">Copy</button>
          </div>
        </div>
      </div>
      <button class="modal-close-btn" id="closeModal">✓ Got it, Close</button>
    </div>
  </div>

  <script type="module">
    // Telegram setup
    const tg = window.Telegram && window.Telegram.WebApp;
    try{ tg && tg.ready(); tg && tg.expand(); if(tg && tg.setHeaderColor) tg.setHeaderColor('secondary_bg_color'); if(tg && tg.setBackgroundColor) tg.setBackgroundColor('secondary_bg_color'); }catch(e){}
    function popup(title, message){ try{ if(tg && tg.showPopup){ tg.showPopup({title, message, buttons:[{type:'close'}]}); return; } }catch(e){} alert(title + "\n\n" + message); }

    // Copy to clipboard function
    function copyToClipboard(text, successMsg = 'Copied!'){
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=>{
          popup('✅ Copied!', successMsg);
        }).catch(()=>{
          fallbackCopy(text, successMsg);
        });
      } else {
        fallbackCopy(text, successMsg);
      }
    }

    function fallbackCopy(text, successMsg){
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try{
        document.execCommand('copy');
        popup('✅ Copied!', successMsg);
      }catch(e){
        popup('❌ Error', 'Could not copy');
      }
      document.body.removeChild(textarea);
    }

    // Navigation handlers
    document.getElementById('tabEarn').addEventListener('click', ()=> window.location.href = 'index.html');
    document.getElementById('tabWatch').addEventListener('click', ()=> window.location.href = 'watch.html');
    document.getElementById('tabWithdraw').addEventListener('click', ()=> window.location.href = 'withdraw.html');
    document.getElementById('backBtn').addEventListener('click', ()=> window.location.href = 'index.html');

    // Prevent bottom overlap
    const navEl = document.querySelector('.nav');
    function applyNavOffset(){ const h = navEl ? navEl.offsetHeight : 100; document.documentElement.style.setProperty('--nav-offset', h + 'px'); }
    applyNavOffset(); window.addEventListener('resize', applyNavOffset);
    try{ tg && tg.onEvent && tg.onEvent('viewportChanged', applyNavOffset); }catch(e){}

    // UID
    const UID = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) ? String(tg.initDataUnsafe.user.id) : 'NOT_APP';

    // TON wallet for deposits
    const TONKEEPER_WALLET = 'UQBoXgx2VsAZ5eJ5KK2QXc-Ca0-CFyn75voDdCIkjkQfeJFV';

    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-analytics.js";
    import {
      getDatabase, ref, push, set, onValue, runTransaction, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCVsbQ5GUkz5SIXy2Fp3Q6SPyv2peFhnK8",
      authDomain: "moneys-cats-bot.firebaseapp.com",
      databaseURL: "https://moneys-cats-bot-default-rtdb.firebaseio.com",
      projectId: "moneys-cats-bot",
      storageBucket: "moneys-cats-bot.firebasestorage.app",
      messagingSenderId: "94689984727",
      appId: "1:94689984727:web:d4ef7757c6521ac2733092",
      measurementId: "G-B2D4Y2MQ5Z"
    };
    const app = initializeApp(firebaseConfig); try{ getAnalytics(app); }catch(e){}
    const db = getDatabase(app);

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const tab=btn.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        btn.classList.add('active'); document.getElementById(tab+'Tab').classList.add('active'); applyNavOffset();
      });
    });

    // TON Balance
    const tonBalanceEl = document.getElementById('tonBalance');
    const tonBalRef = ref(db, `users/${UID}/ton_balance`);
    let currentTonBalance = 0;

    onValue(tonBalRef, (snap)=>{
      currentTonBalance = parseFloat(snap.val()||0);
      tonBalanceEl.textContent = currentTonBalance.toFixed(2);
    });

    // Deposit Modal
    const depositModal = document.getElementById('depositModal');
    const depositBtn = document.getElementById('depositBtn');
    const closeModal = document.getElementById('closeModal');
    const depositAddress = document.getElementById('depositAddress');
    const depositMemo = document.getElementById('depositMemo');
    const copyAddress = document.getElementById('copyAddress');
    const copyMemo = document.getElementById('copyMemo');

    const DEPOSIT_MEMO = `Cats deposit TON ${UID}`;

    depositBtn.addEventListener('click', ()=>{
      depositAddress.textContent = TONKEEPER_WALLET;
      depositMemo.textContent = DEPOSIT_MEMO;
      depositModal.classList.add('show');
    });

    closeModal.addEventListener('click', ()=>{
      depositModal.classList.remove('show');
    });

    depositModal.addEventListener('click', (e)=>{
      if(e.target === depositModal){
        depositModal.classList.remove('show');
      }
    });

    copyAddress.addEventListener('click', ()=>{
      copyToClipboard(TONKEEPER_WALLET, 'Wallet address copied!');
    });

    copyMemo.addEventListener('click', ()=>{
      copyToClipboard(DEPOSIT_MEMO, 'Memo copied!');
    });

    // Task calc + create (deduct from TON balance)
    const taskAmount = document.getElementById('taskAmount'); 
    const maxUsers = document.getElementById('maxUsers');
    const createTaskBtn = document.getElementById('createTaskBtn');

    function calcUsers(){ 
      const amount = Math.max(0, parseFloat(taskAmount.value) || 0); 
      const users = Math.floor((amount/0.05)*100); 
      maxUsers.textContent = users.toLocaleString(); 
    }
    
    taskAmount && taskAmount.addEventListener('input', calcUsers); 
    calcUsers();

    createTaskBtn.addEventListener('click', async ()=>{
      const title = document.getElementById('taskTitle').value.trim();
      const link = document.getElementById('taskLink').value.trim();
      const amountTon = parseFloat(document.getElementById('taskAmount').value) || 0;
      
      if(!title) return popup('❌ Error','Please enter task title');
      if(!link) return popup('❌ Error','Please enter task link');
      if(amountTon < 0.05) return popup('❌ Error','Minimum 0.05 TON required');
      
      // Check balance
      if(currentTonBalance < amountTon){
        return popup('❌ Insufficient Balance', `You need ${amountTon} TON but have only ${currentTonBalance.toFixed(2)} TON. Please deposit first.`);
      }

      const usersCap = Math.floor((amountTon/0.05)*100);

      // Deduct TON balance atomically
      let deducted = false;
      await runTransaction(tonBalRef, (bal)=>{
        bal = parseFloat(bal||0);
        if(isNaN(bal)) bal = 0;
        if(bal < amountTon) return; // abort
        deducted = true;
        return bal - amountTon;
      });

      if(!deducted){
        return popup('❌ Error','Insufficient TON balance. Transaction failed.');
      }

      // Create task after successful deduction
      const taskRef = push(ref(db,'tasks'));
      const payload = { 
        owner_uid: UID, 
        title, 
        link, 
        amount_ton: amountTon, 
        max_users: usersCap, 
        used_users: 0, 
        status: 'active', 
        created_at: serverTimestamp()
      };
      await set(taskRef, payload);
      await set(ref(db,`user_tasks/${UID}/${taskRef.key}`), true);

      popup('✅ Task Created!', `Task "${title}" created successfully!\nBudget: ${amountTon} TON\nMax Users: ${usersCap}`);
      
      // Clear form
      document.getElementById('taskTitle').value = '';
      document.getElementById('taskLink').value = '';
      document.getElementById('taskAmount').value = '0.05';
      calcUsers();
    });

    // Promo: balance + budget enforce + atomic deduct + history
    const catsBalanceEl = document.getElementById('catsBalance');
    const budgetEl = document.getElementById('promoBudget');
    const maxUsesEl = document.getElementById('promoMaxUses');
    const minReqEl = document.getElementById('minRequiredCats');
    const afterBalEl = document.getElementById('afterBalanceCats');
    const minBox = document.getElementById('minBox');
    const afterBox = document.getElementById('afterBox');
    const createPromoBtn = document.getElementById('createPromoBtn');
    const promoList = document.getElementById('promoList');
    const promoListEmpty = document.getElementById('promoListEmpty');

    const userRef = ref(db, `users/${UID}`);
    const balRef = ref(db, `users/${UID}/balance`);

    // Live balance
    let currentBalance = 0;
    onValue(balRef, (snap)=>{
      currentBalance = parseInt(snap.val()||0,10);
      catsBalanceEl.textContent = currentBalance.toLocaleString();
      recomputePromoState();
    });

    function recomputePromoState(){
      const budget = Math.max(0, parseInt(budgetEl.value||'0',10));
      const maxUses = Math.max(0, parseInt(maxUsesEl.value||'0',10));
      const minReq = maxUses * 10;
      const after = currentBalance - budget;

      minReqEl.textContent = minReq.toLocaleString();
      afterBalEl.textContent = after.toLocaleString();

      // UI states
      const minOk = budget >= minReq;
      const balOk = budget > 0 && currentBalance >= budget;
      minBox.classList.toggle('danger', !minOk && maxUses>0);
      afterBox.classList.toggle('danger', !balOk && budget>0);
      createPromoBtn.disabled = !(minOk && balOk && maxUses>0);
    }

    budgetEl.addEventListener('input', recomputePromoState);
    maxUsesEl.addEventListener('input', recomputePromoState);

    function genPromoCode(len=10){
      const chars='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'; let s='';
      for(let i=0;i<len;i++){ s += chars[Math.floor(Math.random()*chars.length)]; }
      return s;
    }

    // History loader with new design
    function loadPromoHistory(){
      onValue(ref(db,`user_promos/${UID}`),(snap)=>{
        promoList.innerHTML=''; const map = snap.val()||{}; const codes = Object.keys(map);
        if(codes.length===0){ promoListEmpty.style.display='block'; return; }
        promoListEmpty.style.display='none';
        codes.forEach(code=>{
          onValue(ref(db,`promos/${code}`),(pSnap)=>{
            const p = pSnap.val()||{};
            const used = p.used_count||0;
            const max = p.max_uses||0;
            const avail = Math.max(0, max - used);
            const isExhausted = avail === 0;
            const progress = max > 0 ? (used / max) * 100 : 0;

            // Remove old item if exists
            const oldItem = promoList.querySelector(`[data-promo-code="${code}"]`);
            if(oldItem) oldItem.remove();

            const item = document.createElement('div');
            item.className = `promo-item ${isExhausted ? 'exhausted' : ''}`;
            item.setAttribute('data-promo-code', code);
            
            item.innerHTML = `
              <div class="promo-header">
                <div class="promo-code-wrapper">
                  <div class="promo-code">${code}</div>
                  <button class="copy-btn" data-code="${code}">📋 Copy</button>
                </div>
                <span class="promo-status ${isExhausted ? 'exhausted' : 'active'}">
                  ${isExhausted ? '🔴 Exhausted' : '🟢 Active'}
                </span>
              </div>
              <div class="promo-stats">
                <div class="promo-stat">
                  <div class="promo-stat-label">Available</div>
                  <div class="promo-stat-value">${avail}</div>
                </div>
                <div class="promo-stat">
                  <div class="promo-stat-label">Claimed</div>
                  <div class="promo-stat-value">${used}/${max}</div>
                </div>
                <div class="promo-stat">
                  <div class="promo-stat-label">Reward/User</div>
                  <div class="promo-stat-value">${p.reward_per_user||0} 🐱</div>
                </div>
                <div class="promo-stat">
                  <div class="promo-stat-label">Total Budget</div>
                  <div class="promo-stat-value">${p.total_budget||0} 🐱</div>
                </div>
              </div>
              <div class="promo-progress">
                <div class="promo-progress-bar" style="width:${progress}%"></div>
              </div>
            `;
            
            promoList.appendChild(item);

            // Add copy button event
            const copyBtn = item.querySelector('.copy-btn');
            copyBtn.addEventListener('click', ()=> copyToClipboard(code, `Promo code "${code}" copied!`));
          });
        });
      });
    }
    loadPromoHistory();

    // Create promo with atomic balance deduction
    createPromoBtn.addEventListener('click', async ()=>{
      const budget = parseInt(budgetEl.value,10) || 0;
      const maxUses = parseInt(maxUsesEl.value,10) || 0;
      const minRequired = maxUses * 10;
      if(maxUses < 1) return popup('❌ Error','Max uses must be at least 1');
      if(budget < minRequired) return popup('❌ Error',`Budget must be ≥ ${minRequired} CATS for ${maxUses} users`);

      // Deduct balance atomically
      let deducted = false;
      const rewardPerUser = Math.floor(budget / maxUses);
      await runTransaction(balRef, (bal)=>{
        bal = parseInt(bal||0,10);
        if(isNaN(bal)) bal = 0;
        if(bal < budget) return; // abort
        deducted = true;
        return bal - budget;
      });

      if(!deducted){
        recomputePromoState();
        return popup('❌ Error','Insufficient balance for this budget');
      }

      // Create promo after successful deduction
      const code = genPromoCode(10);
      const promoRef = ref(db,`promos/${code}`);
      const data = {
        owner_uid: UID,
        code,
        reward_per_user: rewardPerUser,
        max_uses: maxUses,
        used_count: 0,
        total_budget: budget,
        min_required: minRequired,
        active: true,
        created_at: serverTimestamp()
      };
      await set(promoRef, data);
      await set(ref(db,`user_promos/${UID}/${code}`), true);

      popup('✅ Promo Created',`Code: ${code}\nPer-User: ${rewardPerUser} CATS\nMax Uses: ${maxUses}\nBudget: ${budget} CATS`);
      budgetEl.value = '';
      maxUsesEl.value = '';
      recomputePromoState();
    });
  </script>
</body>
</html>