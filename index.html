<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1" />
  <title>Earn ‚Äî CATS</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-bg-color,#0a0a0f);
      --fg: var(--tg-theme-text-color,#fff);
      --card: var(--tg-theme-secondary-bg-color,#1a1a24);
      --accent: var(--tg-theme-button-color,#8b5cf6);
      --accent-text: var(--tg-theme-button-text-color,#fff);
      --sep: var(--tg-theme-section-separator-color,#2a2a3a);
      --success: #10b981;
      --warning: #f59e0b;
      --nav-offset: 100px;
      --wrap-max: 480px;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;overflow-x:hidden;touch-action:pan-y}
    body{
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,sans-serif;
      background:linear-gradient(180deg, var(--bg) 0%, #1a0a2e 100%);
      color:var(--fg);
      padding-bottom: var(--nav-offset);
    }
    .wrap{max-width:var(--wrap-max);margin:0 auto;padding:20px 16px}
    
    .header{
      text-align:center;margin-bottom:24px;padding:20px 0;
      background:linear-gradient(135deg, rgba(139,92,246,0.1) 0%, rgba(59,130,246,0.1) 100%);
      border-radius:20px;border:1px solid rgba(139,92,246,0.2);
    }
    .header h1{font-size:20px;font-weight:800;letter-spacing:2px;margin-bottom:8px;
      background:linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .header p{font-size:13px;opacity:0.7}

    .balance-box{
      background:linear-gradient(135deg, rgba(139,92,246,0.15) 0%, rgba(59,130,246,0.15) 100%);
      border-radius:20px;padding:24px;margin-bottom:20px;
      box-shadow:0 8px 32px rgba(139,92,246,0.2), 0 2px 0 0 rgba(255,255,255,.05) inset;
      border:1px solid rgba(139,92,246,0.3);
      position:relative;overflow:hidden;
    }
    .balance-box::before{
      content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
      background:radial-gradient(circle, rgba(139,92,246,0.1) 0%, transparent 70%);
      animation:pulse 3s ease-in-out infinite;
    }
    @keyframes pulse{0%,100%{opacity:0.5} 50%{opacity:1}}
    .balance-label{font-size:14px;opacity:0.8;margin-bottom:8px;position:relative;z-index:1}
    .balance{font-size:42px;font-weight:900;letter-spacing:1px;position:relative;z-index:1;
      background:linear-gradient(135deg, #fff 0%, #e0e0e0 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .balance-currency{font-size:20px;font-weight:700;margin-left:8px;opacity:0.9}

    .btn{
      width:100%;margin-top:16px;padding:16px;border:0;border-radius:14px;
      background:linear-gradient(135deg, var(--accent) 0%, #6d28d9 100%);
      color:var(--accent-text);font-weight:700;font-size:15px;cursor:pointer;
      transition:all 0.3s ease;box-shadow:0 4px 20px rgba(139,92,246,0.4);
      position:relative;overflow:hidden;
    }
    .btn::before{
      content:'';position:absolute;top:50%;left:50%;width:0;height:0;
      background:rgba(255,255,255,0.2);border-radius:50%;
      transform:translate(-50%,-50%);transition:width 0.6s, height 0.6s;
    }
    .btn:active::before{width:300px;height:300px}
    .btn:active{transform:translateY(2px);box-shadow:0 2px 10px rgba(139,92,246,0.3)}
    .btn[disabled]{opacity:.5;cursor:not-allowed;background:linear-gradient(135deg, #555 0%, #333 100%)}

    .line{height:1px;background:linear-gradient(90deg, transparent 0%, var(--sep) 50%, transparent 100%);margin:24px 0}

    .promo-card,.task-card{
      background:rgba(26,26,36,0.8);backdrop-filter:blur(10px);
      border-radius:16px;padding:18px;margin-bottom:16px;
      border:1px solid rgba(139,92,246,0.2);
      transition:all 0.3s ease;
    }
    .promo-card:hover,.task-card:hover{
      border-color:rgba(139,92,246,0.5);
      box-shadow:0 8px 24px rgba(139,92,246,0.2);
      transform:translateY(-2px);
    }

    .promo-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .promo-title{font-weight:800;font-size:16px;letter-spacing:0.5px;
      background:linear-gradient(135deg, #fff 0%, #a0a0a0 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .btn-compact{
      padding:10px 18px;border:0;border-radius:10px;
      background:linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color:#fff;font-weight:700;font-size:13px;cursor:pointer;
      transition:all 0.3s ease;box-shadow:0 2px 12px rgba(16,185,129,0.3);
    }
    .btn-compact:active{transform:scale(0.95)}

    .promo-row{display:flex;align-items:center;gap:10px;width:100%}
    .promo-input{
      flex:1;padding:14px;border-radius:12px;border:1px solid rgba(139,92,246,0.3);
      background:rgba(0,0,0,0.3);color:var(--fg);outline:none;font-size:14px;
      transition:all 0.3s ease;
    }
    .promo-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(139,92,246,0.1)}
    .promo-claim{
      padding:14px 20px;border-radius:12px;border:0;
      background:linear-gradient(135deg, var(--accent) 0%, #6d28d9 100%);
      color:var(--accent-text);font-weight:700;font-size:14px;cursor:pointer;
      box-shadow:0 4px 16px rgba(139,92,246,0.3);transition:all 0.3s ease;
    }
    .promo-claim:active{transform:scale(0.95)}

    .task-row{display:flex;align-items:center;justify-content:space-between;gap:14px}
    .task-left{min-width:0;flex:1}
    .task-icon{font-size:24px;margin-bottom:8px}
    .task-title{font-weight:700;font-size:16px;margin-bottom:8px}
    .task-reward{font-size:14px;color:var(--success);font-weight:600}

    .stats{
      display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;
    }
    .stat-card{
      background:rgba(26,26,36,0.6);padding:16px;border-radius:14px;
      border:1px solid rgba(139,92,246,0.2);text-align:center;
    }
    .stat-value{font-size:24px;font-weight:800;color:var(--accent)}
    .stat-label{font-size:12px;opacity:0.7;margin-top:4px}

    .section-title{
      font-size:18px;font-weight:800;margin:24px 0 16px;
      background:linear-gradient(135deg, #fff 0%, #a0a0a0 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .section-header{
      display:flex;align-items:center;justify-content:space-between;
      margin:24px 0 16px;
    }

    .empty-state{
      text-align:center;padding:40px 20px;opacity:0.6;
    }
    .empty-state-icon{font-size:48px;margin-bottom:12px}
    .empty-state-text{font-size:14px}

    .nav{
      position:fixed;z-index:1000;left:0;right:0;bottom:0;
      background:rgba(26,26,36,0.95);backdrop-filter:blur(20px);
      padding:12px 12px calc(12px + env(safe-area-inset-bottom,0px));
      border-top:1px solid rgba(139,92,246,0.2);
      box-shadow:0 -8px 32px rgba(0,0,0,0.5);
    }
    .nav-row{
      max-width:var(--wrap-max);margin:0 auto;display:flex;gap:10px;
      height:70px;align-items:center;
    }
    .tab{
      flex:1;text-align:center;padding:12px;border-radius:14px;
      background:rgba(0,0,0,0.3);color:var(--fg);font-weight:600;font-size:13px;
      cursor:pointer;user-select:none;transition:all 0.3s ease;
      border:1px solid transparent;
    }
    .tab.active{
      background:linear-gradient(135deg, rgba(139,92,246,0.3) 0%, rgba(59,130,246,0.3) 100%);
      border-color:rgba(139,92,246,0.5);
      box-shadow:0 4px 16px rgba(139,92,246,0.3);
    }
    .tab:active{transform:scale(0.95)}

    .task-card.completing{
      opacity:0.5;
      pointer-events:none;
      animation:fadeOut 0.3s ease-out;
    }
    @keyframes fadeOut{
      from{opacity:1;transform:scale(1)}
      to{opacity:0;transform:scale(0.95)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>üê± CATS REWARDS</h1>
      <p>Earn, Collect, Withdraw</p>
    </div>

    <div class="balance-box">
      <div class="balance-label">Total Balance</div>
      <div>
        <span class="balance" id="balance">0</span>
        <span class="balance-currency">CATS</span>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="statTasks">0</div>
        <div class="stat-label">Tasks Done</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statStreak">0</div>
        <div class="stat-label">Day Streak</div>
      </div>
    </div>

    <button id="checkin" class="btn">üéÅ Daily Check‚Äëin ‚Ä¢ +100 CATS</button>

    <div class="line"></div>

    <div class="promo-card">
      <div class="promo-header">
        <div class="promo-title">üéüÔ∏è PROMO CODE</div>
      </div>
      <div class="promo-row">
        <input id="promoInput" class="promo-input" type="text" placeholder="Enter code (e.g., CATS100)" />
        <button id="promoClaimBtn" class="promo-claim">CLAIM</button>
      </div>
    </div>

    <div class="section-header">
      <div class="section-title">üìã Available Tasks</div>
      <button id="promoCreateBtn" class="btn-compact">+ Create</button>
    </div>
    <div id="tasksList"></div>
    <div id="tasksEmpty" class="empty-state" style="display:none">
      <div class="empty-state-icon">‚ú®</div>
      <div class="empty-state-text">All tasks completed! Check back later for new tasks.</div>
    </div>
  </div>

  <div class="nav">
    <div class="nav-row">
      <div class="tab active" id="tabEarn">üí∞ Earn</div>
      <div class="tab" id="tabWatch">üì∫ Watch</div>
      <div class="tab" id="tabWithdraw">üí≥ Withdraw</div>
    </div>
  </div>

  <script type="module">
    const tg = window.Telegram && window.Telegram.WebApp;
    try{
      tg && tg.ready();
      tg && tg.expand();
      if(tg && tg.setHeaderColor) tg.setHeaderColor('secondary_bg_color');
      if(tg && tg.setBackgroundColor) tg.setBackgroundColor('secondary_bg_color');
    }catch(e){}

    const navEl = document.querySelector('.nav');
    function applyNavOffset(){
      const h = navEl ? navEl.offsetHeight : 100;
      document.documentElement.style.setProperty('--nav-offset', h + 'px');
    }
    applyNavOffset();
    window.addEventListener('resize', applyNavOffset);
    try{
      tg && tg.onEvent && tg.onEvent('viewportChanged', applyNavOffset);
    }catch(e){}

    const UID = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id)
      ? String(tg.initDataUnsafe.user.id)
      : 'NOT_APP';

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-analytics.js";
    import {
      getDatabase, ref, onValue, runTransaction, serverTimestamp, get
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCVsbQ5GUkz5SIXy2Fp3Q6SPyv2peFhnK8",
      authDomain: "moneys-cats-bot.firebaseapp.com",
      databaseURL: "https://moneys-cats-bot-default-rtdb.firebaseio.com",
      projectId: "moneys-cats-bot",
      storageBucket: "moneys-cats-bot.firebasestorage.app",
      messagingSenderId: "94689984727",
      appId: "1:94689984727:web:d4ef7757c6521ac2733092",
      measurementId: "G-B2D4Y2MQ5Z"
    };
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) {}

    const db = getDatabase(app);

    const balanceEl=document.getElementById('balance');
    const checkinBtn=document.getElementById('checkin');
    const promoInput=document.getElementById('promoInput');
    const promoClaimBtn=document.getElementById('promoClaimBtn');
    const promoCreateBtn=document.getElementById('promoCreateBtn');
    const statTasks=document.getElementById('statTasks');
    const statStreak=document.getElementById('statStreak');
    const tasksList=document.getElementById('tasksList');
    const tasksEmpty=document.getElementById('tasksEmpty');

    const TASK_REWARD = 3000;

    const toInt=(v,d=0)=>Number.parseInt(v??d,10)||d;
    const delay=ms=>new Promise(r=>setTimeout(r,ms));
    const today=()=>new Date().toISOString().slice(0,10);
    function sep(n){ return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
    function toast(msg,ok=true){
      try{ if(tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred(ok?'success':'error'); }catch(e){}
      try{ if(tg && tg.showPopup){ tg.showPopup({title: ok?'‚úÖ Success':'‚ÑπÔ∏è Notice', message: msg, buttons:[{type:'close'}]}); return; } }catch(e){}
      try{ alert(msg); }catch(e){}
    }

    const userRef = ref(db, `users/${UID}`);
    const tasksRef = ref(db, 'tasks');
    const promosRef = ref(db, 'promos');

    await runTransaction(userRef, (u)=>{
      if(u) return u;
      return {
        balance: 0,
        last_checkin: "",
        streak: 0,
        tasks_done: 0,
        completed_tasks: {},
        promo_used: {},
        updated_at: serverTimestamp()
      };
    });

    let userData = {};

    function applyUser(u){
      userData = u || {};
      balanceEl.textContent = sep(toInt(u?.balance||0));
      statTasks.textContent = String(toInt(u?.tasks_done||0));
      statStreak.textContent = String(toInt(u?.streak||0));
      const t = today();
      if(u?.last_checkin === t){
        checkinBtn.textContent='‚úÖ Checked‚Äëin Today';
        checkinBtn.disabled=true;
      } else {
        checkinBtn.textContent='üéÅ Daily Check‚Äëin ‚Ä¢ +100 CATS';
        checkinBtn.disabled=false;
      }
    }

    onValue(userRef, (snap)=>{
      applyUser(snap.val()||{});
      applyNavOffset();
    });

    function loadTasks(){
      onValue(tasksRef, (snap)=>{
        const allTasks = snap.val() || {};
        const completedTasks = userData.completed_tasks || {};
        tasksList.innerHTML = '';
        
        let hasAvailableTasks = false;
        
        Object.keys(allTasks).forEach(taskId => {
          const task = allTasks[taskId];
          
          if(task.status === 'active' && !completedTasks[taskId]){
            const usedUsers = task.used_users || 0;
            const maxUsers = task.max_users || 0;
            
            if(usedUsers < maxUsers){
              hasAvailableTasks = true;
              const taskCard = document.createElement('div');
              taskCard.className = 'task-card';
              taskCard.setAttribute('data-task-id', taskId);
              taskCard.innerHTML = `
                <div class="task-row">
                  <div class="task-left">
                    <div class="task-icon">‚ú®</div>
                    <div class="task-title">${task.title || 'Task'}</div>
                    <div class="task-reward">+${TASK_REWARD} CATS</div>
                  </div>
                  <button class="btn-compact task-btn" data-task-id="${taskId}" data-task-link="${task.link}">Start</button>
                </div>
              `;
              tasksList.appendChild(taskCard);
            }
          }
        });

        if(!hasAvailableTasks){
          tasksEmpty.style.display = 'block';
          tasksList.style.display = 'none';
        } else {
          tasksEmpty.style.display = 'none';
          tasksList.style.display = 'block';
        }

        document.querySelectorAll('.task-btn').forEach(btn => {
          btn.addEventListener('click', async function(){
            const taskId = this.getAttribute('data-task-id');
            const taskLink = this.getAttribute('data-task-link');
            const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
            
            this.disabled = true;
            const prevText = this.textContent;
            this.textContent = '‚è≥ Wait';
            
            window.open(taskLink, '_blank');
            
            await delay(5000);
            
            const taskRef = ref(db, `tasks/${taskId}`);
            let success = false;
            
            await runTransaction(taskRef, (task) => {
              if(!task) return task;
              const used = task.used_users || 0;
              const max = task.max_users || 0;
              if(used >= max) return task;
              return { ...task, used_users: used + 1 };
            });

            await runTransaction(userRef, (u)=>{
              u = u || {};
              const completed = u.completed_tasks || {};
              if(completed[taskId]) return u;
              const bal = toInt(u.balance||0);
              const tasks_done = toInt(u.tasks_done||0);
              success = true;
              return {
                ...u,
                balance: bal + TASK_REWARD,
                tasks_done: tasks_done + 1,
                completed_tasks: { ...completed, [taskId]: true },
                updated_at: serverTimestamp()
              };
            });

            if(success){
              if(taskCard){
                taskCard.classList.add('completing');
                await delay(300);
              }
              
              toast(`üéä +${TASK_REWARD} CATS earned!`);
              
              await delay(500);
              location.reload();
            } else {
              this.textContent = prevText;
              this.disabled = false;
            }
          });
        });

        applyNavOffset();
      });
    }

    loadTasks();

    checkinBtn.addEventListener('click', async ()=>{
      checkinBtn.disabled = true;
      await runTransaction(userRef, (u)=>{
        u = u || {};
        const bal = toInt(u.balance||0);
        const tasks_done = toInt(u.tasks_done||0);
        const streak = toInt(u.streak||0);
        const last = u.last_checkin || "";
        const now = today();
        if(last === now) return u;
        const y = new Date(); y.setDate(y.getDate()-1);
        const yStr = y.toISOString().slice(0,10);
        const newStreak = (last === yStr) ? (streak+1) : 1;
        return {
          ...u,
          balance: bal + 100,
          last_checkin: now,
          streak: newStreak,
          tasks_done: tasks_done + 1,
          updated_at: serverTimestamp()
        };
      });
      toast('üéâ +100 CATS added!');
    });

    promoClaimBtn.addEventListener('click', async ()=>{
      const code = (promoInput.value||'').trim().toUpperCase();
      if(!code){ toast('‚ùå Please enter a promo code',false); return; }
      
      promoClaimBtn.disabled = true;
      const t = promoClaimBtn.textContent;
      promoClaimBtn.textContent = '‚è≥';
      
      const promoSnap = await get(ref(db, `promos/${code}`));
      const promo = promoSnap.val();
      
      if(!promo || !promo.active){
        promoClaimBtn.textContent = t;
        promoClaimBtn.disabled = false;
        toast('‚ùå Invalid or inactive promo code', false);
        return;
      }

      const used = promo.used_count || 0;
      const max = promo.max_uses || 0;
      
      if(used >= max){
        promoClaimBtn.textContent = t;
        promoClaimBtn.disabled = false;
        toast('‚ùå Promo code fully redeemed', false);
        return;
      }

      let success = false;
      const reward = promo.reward_per_user || 0;

      await runTransaction(ref(db, `promos/${code}`), (p) => {
        if(!p) return p;
        const usedCount = p.used_count || 0;
        const maxUses = p.max_uses || 0;
        if(usedCount >= maxUses) return p;
        return { ...p, used_count: usedCount + 1 };
      });

      await runTransaction(userRef, (u)=>{
        u = u || {};
        const usedPromos = u.promo_used || {};
        if(usedPromos[code]) return u;
        const bal = toInt(u.balance||0);
        const tasks_done = toInt(u.tasks_done||0);
        success = true;
        return {
          ...u,
          balance: bal + reward,
          tasks_done: tasks_done + 1,
          promo_used: { ...usedPromos, [code]: true },
          updated_at: serverTimestamp()
        };
      });

      promoClaimBtn.textContent = t;
      promoClaimBtn.disabled = false;
      promoInput.value = '';
      
      if(success) toast(`üéâ Redeemed! +${reward} CATS added`);
      else toast('‚ö†Ô∏è Code already redeemed', false);
    });

    promoCreateBtn.addEventListener('click', ()=>{
      window.location.href = 'create.html';
    });

    document.getElementById('tabEarn').addEventListener('click',()=>{});
    document.getElementById('tabWatch').addEventListener('click',()=>{ location.href='watch.html'; });
    document.getElementById('tabWithdraw').addEventListener('click',()=>{ location.href='withdraw.html'; });
  </script>
</body>
</html>
